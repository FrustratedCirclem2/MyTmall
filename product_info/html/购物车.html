<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../../lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/list-content.css">
    <link rel="stylesheet" href="../css/cartbutton.css">
    <script src="../../lib/jquery.min.js"></script>
    <script src="../../lib/bootstrap/js/bootstrap.min.js"></script>
</head>
<body>
<div class="cartDiv">
    <div class="cartTitle pull-right">
        <span>已选商品 （不含运费）</span>
        <span class="cartTitlePrice">￥0.00</span>
        <button class="createOrderButton" style="background-color: rgb(170,170,170);" disabled>结算</button>
    </div>

    <div class="cartProductList">
        <table class="cartProductTable">
            <thead>
            <tr>
                <th class="selectAndImage">
                    <img src="../img/cartNotSelected.png" class="selectAllItem" selectit="false">
                    全选
                </th>
                <th>商品信息</th>
                <th>单价</th>
                <th>数量</th>
                <th width="120px">金额</th>
                <th class="operation">操作</th>
            </tr>
            </thead>
            <tbody>
            <tr class="cartProductItemTR" oiid="936">
                <td>
                    <img src="../img/cartNotSelected.png" class="cartProductItemIfSelected" oiid="936" selectit="false">
                    <a href="#nowhere" style="display:none"><img src="../img/cartSelected.png"></a>
                    <img width="40px" src="../img/3665.jpg" class="cartProductImg">
                </td>
                <td>
                    <div class="cartProductLinkOutDiv">
                        <a class="cartProductLink" href="#nowhere">美国iRobot扫地机器人吸尘器全自动家用智能扫地机650 天猫电器城</a>
                        <div class="cartProductLinkInnerDiv">
                            <img title="支持信用卡支付" src="../img/creditcard.png">
                            <img title="消费者保障服务,承诺7天退货" src="../img/7day.png">
                            <img title="消费者保障服务,承诺如实描述" src="../img/promise.png">
                        </div>
                    </div>
                </td>
                <td>
                    <span class="cartProductItemOringalPrice">￥7580.0</span>
                    <span class="cartProductItemPromotionPrice">￥5306.0</span>
                </td>
                <td>
                    <div class="cartProductChangeNumberDiv">
                        <span pid="365" class="hidden orderItemStock ">75</span>
                        <span pid="365" class="hidden orderItemPromotePrice ">5306.0</span>
                        <a href="#nowhere" class="numberMinus" pid="365">-</a>
                        <input value="1" autocomplete="off" class="orderItemNumberSetting" oiid="936" pid="365">
                        <a href="#nowhere" class="numberPlus" pid="365" stock="75">+</a>
                    </div>
                </td>
                <td>
                    <span pid="365" oiid="936" class="cartProductItemSmallSumPrice">￥5,306.00</span>
                </td>
                <td>
                    <a href="#nowhere" oiid="936" class="deleteOrderItem">删除</a>
                </td>
            </tr>
            <tr class="cartProductItemTR" oiid="935">
                <td>
                    <img src="../img/cartNotSelected.png" class="cartProductItemIfSelected" oiid="935" selectit="false">
                    <a href="#nowhere" style="display:none"><img src="../img/cartSelected.png"></a>
                    <img width="40px" src="../img/8510.jpg" class="cartProductImg">
                </td>
                <td>
                    <div class="cartProductLinkOutDiv">
                        <a class="cartProductLink" href="#nowhere">阔腿裤三件套装女夏装2016新款大码雪纺时尚休闲气质棉麻九分裤潮</a>
                        <div class="cartProductLinkInnerDiv">
                            <img title="支持信用卡支付" src="../img/creditcard.png">
                            <img title="消费者保障服务,承诺7天退货" src="../img/7day.png">
                            <img title="消费者保障服务,承诺如实描述" src="../img/promise.png">
                        </div>
                    </div>
                </td>
                <td>
                    <span class="cartProductItemOringalPrice">￥235.0</span>
                    <span class="cartProductItemPromotionPrice">￥152.75</span>
                </td>
                <td>
                    <div class="cartProductChangeNumberDiv">
                        <span pid="809" class="hidden orderItemStock ">17</span>
                        <span pid="809" class="hidden orderItemPromotePrice ">152.75</span>
                        <a href="#nowhere" class="numberMinus" pid="809">-</a>
                        <input value="1" autocomplete="off" class="orderItemNumberSetting" oiid="935" pid="809">
                        <a href="#nowhere" class="numberPlus" pid="809" stock="17">+</a>
                    </div>
                </td>
                <td>
                            <span pid="809" oiid="935" class="cartProductItemSmallSumPrice">
                            ￥152.75
                            </span>
                </td>
                <td>
                    <a href="#nowhere" oiid="935" class="deleteOrderItem">删除</a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="cartFoot">
        <img src="../img/cartNotSelected.png" alt="notSelected" class="selectAllItem" selectit="false">
        <span>全选</span>
        <div class="pull-right">
            <span>已选商品</span>
            <span class="cartSumNumber">0</span><span>件</span>
            <span>合计 （不含运费）</span>
            <span class="cartSumPrice">￥0.00</span>
            <button class="createOrderButton" style="background-color: rgb(170, 170, 170);" disabled="disabled">结算
            </button>
        </div>
    </div>
</div>
</body>
<script>
    $(function () {
        $('input.orderItemNumberSetting').on('keyup',function () {
            var num = $(this).val();
            var stock = $(this).attr('stock');
            var pid = $(this).attr('pid');
            var price = $('span.orderItemPromotePrice[pid=' + pid + ']').text();
            if(isNaN(num) || num =='' || num <= 0){
                num = 1;
                $(this).val(parseInt(num));
            }
            num = parseInt(num);
            if(num > stock){
                num = stock;
            }
            syncPrice(pid,num,price);
        });
        $('.numberPlus').on('click', function () {
            var pid = $(this).attr('pid');
            var price = $('span.orderItemPromotePrice[pid=' + pid + ']').text();
            var stock = $(this).attr('stock');
            var num = $('input.orderItemNumberSetting[pid=' + pid + ']').val();
            num++;
            if (num > stock) {
                num = stock;
            }
            syncPrice(pid, num, price);
        });

        $('.numberMinus').on('click', function () {
            var pid = $(this).attr('pid');
            var price = $('span.orderItemPromotePrice[pid=' + pid + ']').text();
            var num = $('input.orderItemNumberSetting[pid=' + pid + ']').val();
            num--;
            if (num <= 0) {
                num = 1;
            }
            syncPrice(pid, num, price);
        });

        $('img.selectAllItem').on('click', function () {
            var selectit = $(this).attr('selectit');
            if ('selectit' == selectit) {
                $('img.selectAllItem').attr('selectit', 'false').attr('src', '../img/cartNotSelected.png');
                $('.cartProductItemIfSelected').each(function () {
                    $(this).attr('selectit', 'false').attr('src', '../img/cartNotSelected.png');
                    $(this).parents('.cartProductItemTR').css('background-color', '#fff');
                });
            }
            else {
                $('img.selectAllItem').attr('selectit', 'selectit').attr('src', '../img/cartSelected.png');
                $('.cartProductItemIfSelected').each(function () {
                    $(this).attr('selectit', 'selectit').attr('src', '../img/cartSelected.png');
                    $(this).parents('.cartProductItemTR').css('background-color', '#FFF8E1');
                });
            }
            calCartSumPriceAndNumber();
            syncCreateOrderButton();
        });

        $('img.cartProductItemIfSelected').on('click', function () {
            var selectit = $(this).attr('selectit');
            if ('selectit' == selectit) {
                $(this).attr('selectit', 'false').attr('src', '../img/cartNotSelected.png')
                    .parents('.cartProductItemTR').css('background-color', '#fff');
            }
            else {
                $(this).attr('selectit', 'selectit').attr('src', '../img/cartSelected.png')
                    .parents('.cartProductItemTR').css('background-color', '#FFF8E1');
            }
            syncSelect();
            calCartSumPriceAndNumber();
            syncCreateOrderButton();
        });
        //根据商品数量，商品价格，同步小计价格,接着调用calCartSumPriceAndNumber函数同步商品总数和价格
        function syncPrice(pid, num, price) {
            $('input.orderItemNumberSetting[pid=' + pid + ']').val(num);
            var cartProductSmallSumPrice = formatMoney(num * price);
            $('span.cartProductItemSmallSumPrice[pid=' + pid + ']').text('￥' + cartProductSmallSumPrice);
            calCartSumPriceAndNumber();
        }

        //显示被选中的商品数量和总价
        function calCartSumPriceAndNumber() {
            var sum = 0;
            var totalNumber = 0;
            $('.cartProductItemIfSelected[selectit=selectit]').each(function () {
                var oiid = $(this).attr('oiid');
                var num = $('input.orderItemNumberSetting[oiid=' + oiid + ']').val();
                var price = $('.cartProductItemSmallSumPrice[oiid=' + oiid + ']').text();
                price = price.replace(/,/g, '');
                price = price.replace(/￥/g, '');
                sum += parseInt(price);
                totalNumber += parseInt(num);
            });
            $('span.cartTitlePrice,span.cartSumPrice').text(formatMoney(sum));
            $('span.cartSumNumber').text(totalNumber);
        }

        //更新全选按钮状态
        function syncSelect() {
            var selectAll = true;
            $('.cartProductItemIfSelected').each(function () {
                if ('false' == $(this).attr('selectit')) {
                    selectAll = false;
                }
            });
            if (selectAll) {
                $('img.selectAllItem').attr('src', '../img/cartSelected.png');
            }
            else {
                $('img.selectAllItem').attr('src', '../img/cartNotSelected.png');
            }
        }

        //更新创建订单按钮的状态
        function syncCreateOrderButton() {
            var selectAny = false;
            $('.cartProductItemIfSelected').each(function () {
                if ('selectit' == $(this).attr('selectit')) {
                    selectAny = true;
                }
            });
            if (selectAny) {
                $('.createOrderButton').css('background-color', '#C40000').removeAttr('disable');
            }
            else {
                $('.createOrderButton').css('background-color', '#AAAAAA').attr('disable');
            }
        }

        //以千进制格式化金额
        function formatMoney(num) {
            num = num.toString().replace(/\$|\,/g, '');
            if (isNaN(num))
                num = "0";
            var sign = (num == (num = Math.abs(num)));
            num = Math.floor(num * 100 + 0.50000000001);
            var cents = num % 100;
            num = Math.floor(num / 100).toString();
            if (cents < 10)
                cents = "0" + cents;
            for (var i = 0; i < Math.floor((num.length - (1 + i)) / 3); i++)
                num = num.substring(0, num.length - (4 * i + 3)) + ',' +
                    num.substring(num.length - (4 * i + 3));
            return (((sign) ? '' : '-') + num + '.' + cents);
        }

    });
</script>
</html>